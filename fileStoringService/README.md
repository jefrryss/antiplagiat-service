# File Storing Service

## Описание микросервиса

`File Storing Service` — микросервис для хранения и выдачи файлов, присланных студентами на проверку.  
Сервис отвечает за:

- Загрузку файлов с информацией о пользователе и типе работы.  
- Сохранение файлов в MinIO (S3-совместимое хранилище).  
- Сохранение метаданных о работе в PostgreSQL (кто загрузил, когда, тип работы, оригинальное имя файла, MIME-тип).  
- Получение списка файлов по типу работы(работы по контрольной, домашки и т.д.).  
- Скачивание файлов с оригинальными именами и корректными MIME-типами.

Сервис является частью более широкой архитектуры, включающей:

## Архитектура
```
fileStoringService/
├─ docs/ - нужен для swagger
├─ cmd/
│ └─ main.go # Точка входа, настройка сервера и роутов
├─ internal/
│ ├─ api/ # HTTP-обработчики (handlers) для взаимодействия с клиентом
│ ├─ application/ # Бизнес-логика, менеджеры, сервисы
│ │ └─ manager/ # Менеджер для работы с файлами (сохраняет, получает)
│ ├─ config/ # Конфигурация сервиса (env, параметры подключения)
│ ├─ domain/ # Сущности (entities) и интерфейсы репозиториев
│ └─ repository/ # Реализация репозиториев. Работа с базой данных и хранилищем файлов (Postgres, MinIO)
├─ migrations/ # SQL миграции для создания таблиц
├─ docker-compose.yml # Сборка и запуск контейнеров
├─ Dockerfile # Сборка Docker-образа сервиса
├─ go.mod / go.sum # Модули Go
└─ README.md # Документация проекта
```
### Слои архитектуры

1. **Domain**
   - Сущности: `Work`, `File`.
   - Интерфейсы репозиториев: `Repo`, `Storage`.
   - Отвечает только за модель данных и контракты.

2. **Repository**
   - `PostgresDB` — работа с PostgreSQL.
   - `MinioStorage` — работа с MinIO (S3-совместимое хранилище).
   - Реализует интерфейсы, определенные в `domain`.

3. **Application**
   - Менеджеры (`ManagerFileStorage`) объединяют логику работы с репозиториями.
   - Содержат все бизнес-правила (сохранение файла, генерация ID, контроль ошибок).

4. **API**
   - HTTP-обработчики (`FileHandler`) предоставляют REST API.
   - Обрабатывают запросы, вызывают методы менеджеров и формируют ответы.
   - Swagger-документация встроена через комментарии.

5. **Cmd**
   - Точка входа приложения (`main.go`).
   - Настройка сервера Gin, роутеров и подключений к репозиториям.

6. **Migrations**
   - SQL-скрипты для создания таблиц `works` и `files` в PostgreSQL.

---

### Поток данных

1. Клиент отправляет файл через `POST /upload`.
2. `FileHandler` получает файл и параметры.
3. `ManagerFileStorage`:
   - Генерирует идентификаторы работы и файла.
   - Сохраняет файл в MinIO.
   - Сохраняет метаданные в PostgreSQL.
4. Для получения списка файлов или скачивания используется `GET /files/list/{typeWork}` и `GET /files/download/{work_id}`.
5. Метаданные и файл возвращаются клиенту в корректном формате.

---

### Docker и контейнеризация

- Каждый компонент (PostgreSQL, MinIO, File Storing Service) запускается в отдельном контейнере.
- Взаимодействие между контейнерами настроено через Docker Compose.
- Сервис можно запустить командой:

```bash
docker compose up --build
```
Проверить работу микро сервиса можно с помощью swagger 
Нужно запустить проект и перейти по ссылке http://localhost:8080/swagger/index.html#/
```bash
docker compose up --build
```
# API File Storing Service

## UploadFile

**Endpoint:** `POST /upload`  
**Описание:** Загружает файл через менеджер, сохраняет его в MinIO и сохраняет метаданные работы в БД.

**Параметры (form-data):**

- `userName` (string, обязательный) — имя пользователя, загружающего файл
- `typeWork` (string, обязательный) — категория или тип работы
- `file` (file, обязательный) — сам файл

**Ответы:**

```json
{
  "work_id": "UUID загруженной работы"
}
```

##  GetFilesList

**Endpoint:** `GET /files/list/{typeWork}`  
**Описание:** Возвращает список всех работ для указанного типа работы, включая информацию о файле и данные работы.

**Параметры (path):**

- `typeWork` (string, обязательный) — тип работы

**Ответы:**
```json
{
 "createdAt": "string",
 "file": {
    "contentType": "string",
    "fileName": "string",
    "id": "string"
},
 "id": "string",
 "typeWork": "string",
 "userName": "string"
}
```


## DownloadFile

**Endpoint:** `GET /files/download/{work_id}`  
**Описание:** Отправляет файл из MinIO по UUID работы (work_id).

**Параметры (path):**

- `work_id` (string, обязательный) — UUID работы

**Ответы:**

файл с оригинальным именем и MIME-типом

### Обработка ошибок при падении микросервиса

В случае недоступности одного из зависимых сервисов (например, PostgreSQL или MinIO) микросервис не падает полностью, а корректно обрабатывает ошибку. Ошибки фиксируются на уровне менеджера и репозитория, передаются в HTTP-хендлер, который возвращает клиенту соответствующий код:

- 400 Bad Request — некорректные параметры запроса.

- 404 Not Found — работа или файл не найдены.

- 500 Internal Server Error — ошибка при обращении к БД или хранилищу файлов (MinIO).

Таким образом, клиент получает информативный ответ, а сервис остаётся доступным, что обеспечивает отказоустойчивость системы.
